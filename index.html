<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>OpenAI Voice Assistant</title>
    <meta name="viewport" content="width=device-width">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #0d1117;
            color: #fff;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #chat {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .msg {
            margin-bottom: 20px;
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 10px;
            line-height: 1.4;
        }

        .user {
            background: #1f6feb;
            margin-left: auto;
        }

        .assistant {
            background: #30363d;
            margin-right: auto;
        }

        .status {
            background: #161b22;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9em;
            color: #8b949e;
            margin-bottom: 10px;
        }

        #recordBtn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background: #ff4757;
            margin: 20px auto;
            cursor: pointer;
            transition: .2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: white;
        }

        #recordBtn.recording {
            background: #2ed573;
            animation: pulse 1s infinite;
        }

        #recordBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #8b949e;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<div id="chat"></div>

<button id="recordBtn">üé§</button>

<audio id="player" preload="auto"></audio>

<script>
    // URL WS-—Å–µ—Ä–≤–µ—Ä–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ª–æ–∫–∞–ª—å–Ω—ã–π, –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å)
    let STREAMING_SERVER_URL;
    if (window.location.protocol === 'file:' || !window.location.hostname) {
        STREAMING_SERVER_URL = 'ws://localhost:3000/realtime';
    } else if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        STREAMING_SERVER_URL = `ws://${window.location.hostname}:3000/realtime`;
    } else {
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        STREAMING_SERVER_URL = `${wsProtocol}//${window.location.host}/realtime`;
    }

    console.log('WS URL:', STREAMING_SERVER_URL);

    let mediaRecorder; // –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –Ω–æ –ø—É—Å—Ç—å –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    let ws;
    let isRecording = false;
    let audioContext = null;
    let audioSource = null;
    let audioProcessor = null;
    let micStream = null;

    const chat = document.getElementById("chat");
    const recBtn = document.getElementById("recordBtn");
    const player = document.getElementById("player");

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è sessionId
    let sessionId = localStorage.getItem('sessionId');
    if (!sessionId) {
        sessionId = crypto.randomUUID();
        localStorage.setItem('sessionId', sessionId);
    }

    function addMessage(text, who) {
        const div = document.createElement("div");
        div.className = "msg " + who;
        div.textContent = text;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
        return div;
    }

    function addStatus(text) {
        const div = document.createElement("div");
        div.className = "status";
        div.innerHTML = `<span class="loading"></span> ${text}`;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
        return div;
    }

    // –ü—Ä–æ—Å—Ç–∞—è —Ä–∞–±–æ—Ç–∞ —Å WS-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º
    function ensureWebSocket() {
        if (ws && ws.readyState === WebSocket.OPEN) return ws;

        ws = new WebSocket(STREAMING_SERVER_URL);

        ws.binaryType = 'arraybuffer';

        ws.onopen = () => {
            console.log('WS connected');
        };

        ws.onclose = () => {
            console.log('WS closed');
        };

        ws.onerror = (e) => {
            console.error('WS error', e);
        };

        ws.onmessage = (event) => {
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è Realtime API –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç/—Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç
            if (typeof event.data === 'string') {
                try {
                    const msg = JSON.parse(event.data);
                    console.log('WS EVENT FROM OPENAI:', msg);

                    // –£–ø—Ä–æ—â—ë–Ω–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ —Å –≥–æ—Ç–æ–≤—ã–º —Ç–µ–∫—Å—Ç–æ–º –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
                    if (msg.type === 'assistant.text' && msg.text) {
                        addMessage(msg.text, "assistant");
                        return;
                    }

                    // –¢–µ–∫—Å—Ç–æ–≤—ã–π –≤—ã–≤–æ–¥ (–µ—Å–ª–∏ –º–æ–¥–µ–ª—å –≤–µ—Ä–Ω—ë—Ç text-—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ)
                    if (msg.type === 'response.output_text.delta' && msg.delta) {
                        console.log('TEXT DELTA:', msg.delta);
                    }

                    if (msg.type === 'response.output_text.done' && msg.output) {
                        const out = msg.output[0];
                        if (out && Array.isArray(out.content) && out.content[0]?.text) {
                            const finalText = out.content[0].text;
                            addMessage(finalText, "assistant");
                        }
                    }

                    // –ï—Å–ª–∏ –ø—Ä–∏—à–ª–æ —Å–æ–±—ã—Ç–∏–µ –æ–± –æ—à–∏–±–∫–µ ‚Äî –ø–æ–∫–∞–∂–µ–º –≤ —á–∞—Ç–µ
                    if (msg.type && msg.type.includes('error')) {
                        addMessage(`‚ùå –û—à–∏–±–∫–∞ Realtime: ${JSON.stringify(msg)}`, "assistant");
                    }
                } catch (e) {
                    console.warn('Non-JSON text message', event.data);
                }
            }
        };

        return ws;
    }

    // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ Float32 [-1,1] –≤ Int16 PCM, —Å –ø—Ä–∏–º–∏—Ç–∏–≤–Ω—ã–º –¥–∞—É–Ω-—Å–µ–º–ø–ª–∏–Ω–≥–æ–º –¥–æ 24–∫–ì—Ü –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    function floatTo16BitPCM(input, originalSampleRate) {
        let data = input;
        // –ü—Ä–æ—Å—Ç–æ–π –¥–∞—É–Ω-—Å–µ–º–ø–ª–∏–Ω–≥ —Å 48000 –¥–æ 24000 –ì—Ü: –±–µ—Ä—ë–º –∫–∞–∂–¥—ã–π –≤—Ç–æ—Ä–æ–π —Å—ç–º–ø–ª
        if (originalSampleRate === 48000) {
            const newLength = Math.floor(input.length / 2);
            const down = new Float32Array(newLength);
            for (let i = 0, j = 0; j < newLength; i += 2, j++) {
                down[j] = input[i];
            }
            data = down;
        }

        const buffer = new ArrayBuffer(data.length * 2);
        const view = new DataView(buffer);
        let offset = 0;
        for (let i = 0; i < data.length; i++, offset += 2) {
            let s = Math.max(-1, Math.min(1, data[i]));
            view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true); // little-endian
        }
        return buffer;
    }

    recBtn.onclick = async () => {
        const wsConn = ensureWebSocket();

        if (isRecording) {
            // –°—Ç–æ–ø –∑–∞–ø–∏—Å–∏
            isRecording = false;
            recBtn.classList.remove("recording");
            recBtn.textContent = "üé§";

            // –û—Ç–∫–ª—é—á–∞–µ–º –∞—É–¥–∏–æ-–ø–∞–π–ø–ª–∞–π–Ω
            if (audioProcessor && audioSource) {
                audioSource.disconnect(audioProcessor);
                audioProcessor.disconnect(audioContext.destination);
            }
            if (micStream) {
                micStream.getTracks().forEach(t => t.stop());
            }

            // –°–æ–æ–±—â–∞–µ–º Realtime API, —á—Ç–æ –∞—É–¥–∏–æ–±—É—Ñ–µ—Ä –∑–∞–∫–æ–Ω—á–µ–Ω –∏ –Ω—É–∂–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç
            if (wsConn.readyState === WebSocket.OPEN) {
                wsConn.send(JSON.stringify({ type: 'input_audio_buffer.commit' }));
                wsConn.send(JSON.stringify({ type: 'response.create' }));
            }
            return;
        }

        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }
            });

            micStream = stream;

            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            const source = audioContext.createMediaStreamSource(stream);
            const processor = audioContext.createScriptProcessor(4096, 1, 1);

            processor.onaudioprocess = function (e) {
                if (!isRecording || wsConn.readyState !== WebSocket.OPEN) return;
                const inputBuffer = e.inputBuffer.getChannelData(0);
                const pcmBuffer = floatTo16BitPCM(inputBuffer, audioContext.sampleRate);
                wsConn.send(pcmBuffer);
            };

            source.connect(processor);
            processor.connect(audioContext.destination);

            audioSource = source;
            audioProcessor = processor;

            addMessage("üé§ (voice started)", "user");

            isRecording = true;
            recBtn.classList.add("recording");
            recBtn.textContent = "‚èπÔ∏è";

        } catch (error) {
            console.error('Error accessing microphone:', error);
            addMessage("‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É", "assistant");
        }
    };
</script>

</body>
</html>
