<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Voice Assistant</title>
<style>
body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 2rem; background: #f0f2f5; }
#chat { width: 100%; max-width: 600px; height: 400px; overflow-y: auto; background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin-bottom: 1rem; }
.msg { margin: 0.5rem 0; padding: 0.5rem 1rem; border-radius: 20px; display: inline-block; max-width: 80%; }
.user { background: #d1e7ff; align-self: flex-end; }
.assistant { background: #e2ffe2; align-self: flex-start; }
#recordBtn { padding: 0.5rem 1rem; font-size: 1rem; border-radius: 8px; cursor: pointer; }
#player { display: none; }
</style>
</head>
<body>

<div id="chat"></div>
<button id="recordBtn">üé§ –ù–∞–∂–º–∏ –∏ –≥–æ–≤–æ—Ä–∏</button>
<audio id="player" autoplay></audio>

<script>
const chat = document.getElementById('chat');
const recBtn = document.getElementById('recordBtn');
const player = document.getElementById('player');

let mediaRecorder, chunks = [];
let isRecording = false;
let sessionId = localStorage.getItem('sessionId') || crypto.randomUUID();
localStorage.setItem('sessionId', sessionId);

function addMessage(text, who) {
    const div = document.createElement('div');
    div.className = 'msg ' + who;
    div.textContent = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

recBtn.onclick = async () => {
    if (!isRecording) {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.onstop = async () => {
            const blob = new Blob(chunks, { type: 'audio/webm;codecs=opus' });
            chunks = [];
            addMessage('üé§ (voice message)', 'user');

            const formData = new FormData();
            formData.append('file', blob, 'voice.webm');
            formData.append('sessionId', sessionId);

            try {
                const resp = await fetch('http://localhost:3000/api/voice', {
                    method: 'POST', body: formData
                });
                if (!resp.ok) throw new Error(resp.statusText);

                const reader = resp.body.getReader();
                const audioChunks = [];
                const streamUrl = URL.createObjectURL(new Blob([], { type: 'audio/mpeg' }));
                player.src = streamUrl;

                // Streaming audio
                (async () => {
                    let done, value;
                    while ({done, value} = await reader.read(), !done) {
                        audioChunks.push(value);
                        const blob = new Blob(audioChunks, { type: 'audio/mpeg' });
                        const url = URL.createObjectURL(blob);
                        player.src = url;
                        await player.play().catch(()=>{});
                    }
                })();

            } catch (err) {
                addMessage('‚ùå –û—à–∏–±–∫–∞: ' + err.message, 'assistant');
            }
        };
        mediaRecorder.start();
        isRecording = true;
        recBtn.textContent = '‚èπÔ∏è –°—Ç–æ–ø';
    } else {
        mediaRecorder.stop();
        isRecording = false;
        recBtn.textContent = 'üé§ –ù–∞–∂–º–∏ –∏ –≥–æ–≤–æ—Ä–∏';
    }
};
</script>

</body>
</html>
